"use client";
import { MockMatchService, demoProfiles } from "@/lib/match/mock";
import PeerBadge, { type PeerProfile } from "@/components/PeerBadge";
type MatchGender = 'any' | Gender;
import React, {useEffect, useMemo, useRef, useState} from "react";



import { guardVip } from '@/lib/vip';
import { useVip } from '@/hooks/useVip';
import UpsellModal from '@/components/UpsellModal';
import type { RefObject } from "react";
import { loadPrefs, savePrefs, isVip, type UserPrefs, type Gender } from "@/utils/prefs";

/* ---------- Ù…Ø³Ø§Ø¹Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ---------- */
const GENDER_ICON: Record<Gender, {sym: string; color: string; label: string}> = {
  female: { sym: "â™€", color: "#FF3B30", label: "Female" },
  male:   { sym: "â™‚", color: "#0A84FF", label: "Male" },
  couple: { sym: "â¤", color: "#FF3B30", label: "Couple" },
  lgbtq:  { sym: "ğŸ³ï¸â€ğŸŒˆ", color: "#ffffff", label: "LGBTQ+" },
};

function flagEmoji(regionCode: string): string {
  // ISO-3166-1 alpha-2 -> ğŸ‡ºğŸ‡¸
  if (!regionCode || regionCode.length !== 2) return "ğŸŒ";
  const A = 0x1F1E6;
  const up = regionCode.toUpperCase();
  const ch0 = up.codePointAt(0)! - 65 + A;
  const ch1 = up.codePointAt(1)! - 65 + A;
  return String.fromCodePoint(ch0, ch1);
}
function countryName(code: string, lang: string = 'en') {
  try {
    // ÙŠØ®Ø±Ø¬ Ø§Ù„Ø§Ø³Ù… Ø¨Ù„ØºÙ€Ø© Ø§Ù„Ù…ØªØµÙØ­
    const dn = new (Intl as any).DisplayNames([lang || navigator.language], { type: "region" });
    return dn.of(code) || code;
  } catch { return code; }
}
function supportedRegions(): string[] {
  try {
    const anyIntl = Intl as any;
    if (typeof anyIntl.supportedValuesOf === 'function') {
      const all = anyIntl.supportedValuesOf('region') as string[];
      if (Array.isArray(all) && all.length) {
        // Ø§Ø³ØªØ¨Ø¹Ø¯ Ø§Ù„Ù‚ÙŠÙ… ØºÙŠØ± Ø§Ù„Ø¯ÙˆÙ„ (Ù…Ø«Ù„ 001ØŒ 150...)
        return all.filter(c => typeof c === 'string' && c.length === 2);
      }
    }
  } catch {}
  // Fallback ÙˆØ§Ø³Ø¹ ÙŠØºØ·ÙŠ Ø£ØºÙ„Ø¨ Ø§Ù„Ø¯ÙˆÙ„ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©Ø› Ù„Ù† ÙŠÙ†Ù‡Ø§Ø± Ø§Ù„Ù€ UI Ø¥Ù† ØºØ§Ø¨ supportedValuesOf
  return [
    'DE','US','GB','AE','SA','FR','ES','IT','TR','CA','BR','AU','CH','AT','NL','SE','NO','DK','FI','BE','PL','CZ','SK','HU','RO','BG','GR','PT','IE','IS','EE','LV','LT',
    'RU','UA','BY','KZ','CN','JP','KR','HK','TW','SG','MY','TH','VN','PH','ID','IN','PK','BD','IR','IQ','SY','JO','LB','QA','KW','OM','BH','EG','MA','DZ','TN','LY','SD','KE',
    'NG','GH','ET','TZ','UG','CM','SN','CI','ZA','NA','BW','ZW','MZ','AO','AR','CL','CO','MX','PE','UY','VE','EC','BO','PY','CU','DO','GT','HN','NI','CR','PA','PR','SV','JM',
    'NZ'
  ];
}

/* ---------- Emoji Picker Ø¨Ø³ÙŠØ· ---------- */
const EMOJIS = "ğŸ˜€ ğŸ˜ ğŸ˜‚ ğŸ¤£ ğŸ˜Š ğŸ˜‰ ğŸ™‚ ğŸ™ƒ ğŸ˜ ğŸ¥° ğŸ˜˜ ğŸ˜œ ğŸ¤ª ğŸ¤© ğŸ¥³ ğŸ¤— ğŸ¤” ğŸ¤“ ğŸ˜ ğŸ˜ ğŸ˜ ğŸ˜´ ğŸ˜ª ğŸ˜­ ğŸ˜¡ ğŸ˜‡ ğŸ™ ğŸ‘ ğŸ‘ ğŸ‘‹ ğŸ¤ ğŸ¤ ğŸ’ª ğŸ‘€ ğŸ’‹ â¤ï¸ ğŸ§¡ ğŸ’› ğŸ’š ğŸ’™ ğŸ’œ ğŸ¤ ğŸ–¤ ğŸ’¯ ğŸ”¥ âœ¨ ğŸ‰ ğŸŠ ğŸ ğŸ» ğŸ· â˜• ğŸ¿ ğŸ” ğŸ• ğŸ« ğŸ“ ğŸ’ ğŸ‘ ğŸŒ¹ ğŸŒº ğŸŒ» ğŸŒ ğŸŒ™ â­".split(/\s+/);

/* ---------- Ø£Ù†ÙˆØ§Ø¹ Ø¯Ø§Ø®Ù„ÙŠØ© ---------- */
type Message = { id:string; kind: 'incoming' | 'outgoing'; text:string; ts:number };
const mkMsg = (k: "incoming"|"outgoing", text: string) : Message => ({ id: Math.random().toString(36).slice(2), kind: k, text, ts: Date.now() });
type RemoteMeta = {
  id?: string;
  
  name?: string;
  gender?: Gender;
  country?: string;  // ISO-2 (DE)
  city?: string;
  likes?: number;
  isVip?: boolean;
  avatarUrl?: string;
};

/* ---------- Ù…ÙƒÙˆÙ‘Ù† ÙØ±Ø¹ÙŠ: Ø¨ÙˆØ§Ø¨Ø© VIP ---------- */
function UpsellModal({open,onClose}:{open:boolean; onClose:()=>void}) {
  if(!open) return null;
  const plans = [
    {label:"Daily",   price:"â‚¬1.49"},
    {label:"Weekly",  price:"â‚¬5.99"},
    {label:"Monthly", price:"â‚¬16.99"},
    {label:"Yearly",  price:"â‚¬99.99"},
  ];
  useEffect(() => {
    // inject intro message from peer on match
    // ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ remoteMeta.id ÙƒÙŠ Ù„Ø§ ØªØªÙƒØ±Ø±
    // (Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù„Ø¯ÙŠÙƒ Ø­Ø§Ù„Ø© remoteMetaØŒ ÙÙ„Ù† ÙŠØ­Ø¯Ø« Ø´ÙŠØ¡)
    // @ts-ignore
    if (remoteMeta && remoteMeta.
      // @ts-ignore
      setMessages(prev => [ mkMsg("incoming", String(remoteMeta. ...prev ].slice(0,50));
    }
  }, [/* @ts-ignore */ remoteMeta && remoteMeta.id]);
  return (
    <div className="upgrade-backdrop" onClick={onClose}>
      <div className="upgrade-card" onClick={e=>e.stopPropagation()}>
        <h3>Go VIP to unlock this feature</h3>
        <ul className="plans">
          {plans.map(p=>(
            <li key={p.label}><span>{p.label}</span><b>{p.price}</b></li>
          ))}
        </ul>
        <div className="actions">
          <a href="/subscribe" className="cta">Continue to Subscribe</a>
          <button onClick={onClose} className="ghost">Later</button>
        </div>
      </div>
      <style jsx>{`
        .upgrade-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.55); display:grid; place-items:center; z-index:50}
        .upgrade-card{ width:min(92vw,460px); background:#0f0f0f; color:#fff; border:1px solid rgba(255,255,255,.18); border-radius:14px; padding:16px 16px 12px; box-shadow:0 10px 40px rgba(0,0,0,.55)}
        .plans{ list-style:none; margin:12px 0; padding:0; display:grid; gap:8px}
        .plans li{ display:flex; align-items:center; justify-content:space-between; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.16); border-radius:10px; padding:10px 12px}
        .cta{ background:#FF3B30; color:#fff; border:none; border-radius:10px; padding:10px 14px; text-decoration:none; font-weight:700}
        .ghost{ background:transparent; color:#fff; border:1px solid rgba(255,255,255,.25); border-radius:10px; padding:10px 14px}
        .actions{ display:flex; gap:10px; justify-content:flex-end}
        h3{ margin:0 0 6px; }
      `}</style>
    </div>
  );
}

/* ---------- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© ---------- */
export default function ChatUI(){
  /* ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
  const [userPrefs, setUserPrefs] = useState<UserPrefs>(loadPrefs());

  
  function toggleLike() {
  setLikedMap((prev: Record<string, boolean>) => {
    const next: Record<string, boolean> = { ...prev };
    const id = currentPeerId;
    if (!id) return prev;
    const wasLiked = !!next[id];
    if (wasLiked) {
      delete next[id];
      setDisplayLikes(n => Math.max(0, n - 1));
    } else {
      next[id] = true;
      setDisplayLikes(n => n + 1);
    }
    try { localStorage.setItem("likes", JSON.stringify(next)); } catch {}
    return next;
  });
}

useEffect(()=>savePrefs(userPrefs),[userPrefs]);
  
const vipMe = isVip(userPrefs);

  
  if (typeof liked === "undefined") {
    var liked = !!(currentPeerId && likedMap && likedMap[currentPeerId]);
  }
/* ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª */
  const remoteVideoRef = useRef<HTMLVideoElement|null>(null);
  const localVideoRef  = useRef<HTMLVideoElement|null>(null);

  /* Ø­Ø§Ù„Ø§Øª ÙˆØ§Ø¬Ù‡Ø© */
  const [micMuted, setMicMuted] = useState(false);
  const [showUpsell, setShowUpsell] = useState(false);
  const { vip } = useVip();

  const [spkMuted, setSpkMuted] = useState(false);
  const [beautyOn, setBeautyOn] = useState(false);
  const [showUpgrade, setShowUpgrade] = useState(false);
  const [showEmoji, setShowEmoji] = useState(false);
  const [messages, setMessages] = useState<Message[]>([
    { id:"m1", kind: 'incoming' as 'incoming', text:"Hi there ğŸ‘‹", ts: Date.now()-4000 },
  ]);
  // === mock match wiring ===
  const match = React.useMemo(()=> new MockMatchService(demoProfiles), []);
  const [peer, setPeer] = React.useState<PeerProfile>(demoProfiles[0]);
  React.useEffect(()=>{
    const off = match.onChange((p)=>{
      setPeer(p);
      if (p.
        setMessages(prev => [
          { id: Math.random().toString(36).slice(2), kind: 'incoming' as 'incoming', text: p. ts: Date.now() },
          ...prev
        ].slice(0,50));
      }
    });
    return off;
  },[match]);
  // === end mock wiring ===
  

  /* Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø±Ù */
  const [remoteMeta, setRemoteMeta] = useState<RemoteMeta>({
    name:"Anna", gender:"female", country:"DE", city:"Stuttgart", likes:142, isVip:true,
  });

  /* Ø³Ø­Ø¨ Ù„ÙŠÙ…ÙŠÙ†/ÙŠØ³Ø§Ø± => Prev/Next */
  const touchRef = useRef<{x:number;y:number}|null>(null);
  const onTouchStart = (e:React.TouchEvent)=>{ touchRef.current = {x:e.touches[0].clientX, y:e.touches[0].clientY}; };
  const onTouchEnd = (e:React.TouchEvent)=>{
    const st = touchRef.current; touchRef.current = null; if(!st) return;
    const dx = e.changedTouches[0].clientX - st.x;
    const dy = e.changedTouches[0].clientY - st.y;
    if (Math.abs(dx) > 60 && Math.abs(dx) > Math.abs(dy)) {
      if (dx < 0) doNext(); else doPrev();
    }
  };

  /* Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ùˆ Ø¥Ø¯Ø±Ø§Ø¬ Ø¥ÙŠÙ…ÙˆØ¬ÙŠ */
  const [draft, setDraft] = useState("");
  function sendMessage(){
    const text = draft.trim(); if(!text) return;
    setMessages(prev => [{id:Math.random().toString(36).slice(2), kind: 'outgoing' as 'outgoing', text, ts:Date.now()}, ...prev].slice(0,50));
    setDraft(""); setShowEmoji(false);
  }
  function insertEmoji(ch:string){ setDraft(d => (d + ch)); }

  /* Ø¨ÙˆØ§Ø¨Ø© VIP Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
  function guardVip(doIt:()=>void){
    if (vipMe) doIt(); else setShowUpgrade(true);
  }

  /* Prev/Next + Ø­Ù‚Ù† Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ù‚Ø¯Ù‘Ù…Ø© */
  function injectIntroIfAny(){
    const intro = (userPrefs.
    if (intro && vipMe) {
      setMessages(prev => [{id:Math.random().toString(36).slice(2), kind: 'outgoing' as 'outgoing', text:intro, ts:Date.now()}, ...prev].slice(0,50));
    }
  }
  function doNext(){
    injectIntroIfAny();
    // TODO: Ø±Ø¨Ø· next Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (WebRTC)
    // Ù…Ø¤Ù‚ØªÙ‹Ø§: Ø²Ø¯ Ø§Ù„Ù„Ø§ÙŠÙƒØ§Øª Ù„ØªØ¨ÙŠØ§Ù† Ø§Ù„ØªØºÙŠÙŠØ±
    
  }
  function doPrev(){ guardVip(()=> {
    // TODO: prev Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
  });}

  /* ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
  async function handleSwapCamera(){ guardVip(()=> {
    // TODO: switch deviceId / facingMode
    console.log("swap camera (stub)");
  });}

  /* Ù…ÙØ¶Ù‘Ù„Ø§Øª Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© (Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†) */
  const [openGenderSel, setOpenGenderSel] = useState(false);
  const [openCountrySel, setOpenCountrySel] = useState(false);

  const regions = useMemo(()=>supportedRegions(),[]);
  const myRegion = useMemo(()=>{
    try { return (new (Intl as any).Locale(navigator.language)).maximize().region || null; }
    catch { return null; }
  },[]);

  function setPreferredGender(g: MatchGender){
    if (g === 'any') setUserPrefs(p=>({...p, preferredGender:g}));
    else guardVip(()=> setUserPrefs(p=>({...p, preferredGender:g})));
  }
  function setCountryFilterAll(){ setUserPrefs(p => ({ ...(p as any), countryFilter:'any' } as any)); }
  function setCountryFilterMy(){ setUserPrefs(p => ({ ...(p as any), countryFilter:'my-country' } as any)); }
  function toggleCountry(code:string){
    guardVip(()=> {
      setUserPrefs(p=>{
        const cur = Array.isArray(p.countryFilter)? p.countryFilter.slice(): [];
        const i = cur.indexOf(code);
        if (i>=0) cur.splice(i,1); else cur.push(code);
        return {...p, countryFilter: cur};
      });
    });
  }

  /* Ø±Ø¨Ø· Ø§Ù„ØµÙˆØª Ø§Ù„Ø®Ø§Ø±Ø¬ */
  useEffect(()=>{ if (remoteVideoRef.current) remoteVideoRef.current.muted = spkMuted; },[spkMuted]);

  /* Ù†Ø§ÙØ°Ø© ØªØ±Ù‚ÙŠØ© ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø¶ØºØ· Ù…ÙŠØ²Ø§Øª VIP */
  const [showVipFromToolbar, setShowVipFromToolbar] = useState(false);

  /* API Ø§Ø®ØªØ¨Ø§Ø±ÙŠØ© Ù…Ù† Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ */
  useEffect(()=>{ (window as any).debugSetRemote = (meta:Partial<RemoteMeta>) => setRemoteMeta(m=>({...m, ...meta})); },[]);

  const genderChip = remoteMeta.gender ? GENDER_ICON[remoteMeta.gender] : null;
  const countryChip = remoteMeta.country ? `${flagEmoji(remoteMeta.country)} ${countryName(remoteMeta.country, ((userPrefs as any) || 'en').language ?? 'en')}` : null;

  return (
    <main className="root" dir="ltr" onTouchStart={onTouchStart} onTouchEnd={onTouchEnd}>
      {/* Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠ (ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø·Ø±Ù) */}
      <section className="section section-top">
        <video ref={remoteVideoRef} className="video remote" playsInline autoPlay muted={spkMuted} />
        <div className="overlay gradient-top" aria-hidden />

        {/* Ø´Ø§Ø±Ø© Ø§Ù„Ø·Ø±Ù */}
        const displayLikes = ((((remoteMeta as any)?.likes)||0) + (liked?1:0));
<PeerBadge p={{
    id: (remoteMeta?.name || 'peer'),
    name: remoteMeta?.name,
    gender: (remoteMeta?.gender ?? 'female'),
    country: remoteMeta?.country,
    city: remoteMeta?.city,
    likes: (remoteMeta?.likes ?? 0),
    isVip: remoteMeta?.isVip,
    avatarUrl: remoteMeta?.avatarUrl,
    
  }} />

        {/* Ø³ÙÙ„ÙŠ/ÙŠØ³Ø§Ø±: Ø§Ù„Ø¬Ù†Ø³ + Ø§Ù„Ø¨Ù„Ø¯/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© */}
        <div className="overlay peer-meta-bottom-left">
          {genderChip && <span className="gender" style={{color: genderChip.color}}>{genderChip.sym}</span>}
          <span className="place">{countryChip}{remoteMeta.city ? ` / ${remoteMeta.city}` : ""}</span>
        </div>

        {/* Ø£Ø¹Ù„Ù‰/ÙŠÙ…ÙŠÙ†: Ù…Ø±Ø´Ø­Ø§Øª Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© */}
        <div className="overlay top-right-controls">
          <div className="menu">
            <button className="chip" onClick={()=>setOpenGenderSel(s=>!s)} title="Preferred gender">âš¤ {userPrefs.preferredGender ?? 'any'}</button>
            {openGenderSel && (
              <div className="popover">
                {(['any','female','male','couple','lgbtq'] as MatchGender[]).map(g=>(
                  <button key={g} className="pop-item" onClick={()=>{ setPreferredGender(g); setOpenGenderSel(false); }}>
                    {g === 'any' ? 'All' : GENDER_ICON[g as Gender].label}
                    {g!=='any' && !vipMe && <span className="vip-lock">VIP</span>}
                  </button>
                ))}
              </div>
            )}
          </div>

          <div className="menu">
            <button className="chip" onClick={()=>setOpenCountrySel(s=>!s)} title="Country filter">ğŸŒ Countries</button>
            {openCountrySel && (
              <div className="popover pop-wide">
                <div className="pop-actions">
                  <button onClick={()=>{setCountryFilterAll(); setOpenCountrySel(false);}}>All</button>
                  <button onClick={()=>{setCountryFilterMy(); setOpenCountrySel(false);}}>
                    My country {myRegion ? `(${flagEmoji(myRegion)})` : ""}
                  </button>
                </div>
                <div className="grid">
                  {regions.map(code=>{
                    const active = Array.isArray((userPrefs as any).countryFilter) && (userPrefs as any).countryFilter.includes(code);
                    return (
                      <button key={code} className={"country "+(active?"active":"")} onClick={()=>toggleCountry(code)}>
                        <span className="flag">{flagEmoji(code)}</span>
                        <span className="name">{countryName(code, ((userPrefs as any) || 'en').language ?? 'en')}</span>
                      </button>
                    );
                  })}
                </div>
                {!vipMe && <div className="vip-hint">Selecting specific countries is VIP</div>}
              </div>
            )}
          </div>
        </div>
      </section>

      {/* Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø³ÙÙ„ÙŠ (Ø£Ù†Ø§) */}
      <section className="section section-bottom">
        <video ref={localVideoRef} className={"video local"+(beautyOn?" beauty":"")} playsInline autoPlay muted />
        <div className="overlay self-top-right">
          <button className="chip" onClick={handleSwapCamera}>â‡„ Swap camera</button>
          {isVip(userPrefs) && <span className="vip-chip">VIP</span>}
        </div>

        {/* Ø´Ø±ÙŠØ· Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */}
        <div className="message-input">
          <input
            aria-label="Type a message"
            placeholder="Type a message..."
            value={draft}
            onChange={(e)=>setDraft(e.target.value)}
            onKeyDown={(e)=> e.key === 'Enter' && sendMessage()}
          />
          <button className="emoji" onClick={()=>setShowEmoji(v=>!v)} title="Emoji">ğŸ™‚</button>
          <button className="send" onClick={sendMessage} aria-label="Send">â¤</button>
        </div>
        {showEmoji && (
          <div className="emoji-panel">
            {EMOJIS.map(e => <button key={e} onClick={()=>insertEmoji(e)}>{e}</button>)}
          </div>
        )}

        {/* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª */}
        <div className="toolbar" role="toolbar">
          <button className="btn big left" onClick={()=> guardVip(()=>doPrev())}>âŸ¨ Prev</button>
          <div className="center-btns">
            <button className="btn icon" onClick={()=>setSpkMuted(m=>!m)} title="Speaker">
              {spkMuted ? "ğŸ”‡" : "ğŸ”Š"}
            </button>
            <button className="btn icon" onClick={()=>setMicMuted(m=>!m)} title="Microphone">
              {micMuted ? "ğŸ™ï¸âœ–" : "ğŸ™ï¸"}
            </button>
            <button className={"btn icon"+(beautyOn?" active":"")} onClick={()=> guardVip(()=>setBeautyOn(v=>!v))} title="Beauty (VIP)">
              âœ¨
            </button>
            <button className="btn icon" onClick={()=>location.assign('/settings')} title="Settings">âš™ï¸</button>
            <button className="btn icon stop" onClick={()=>console.log('stop/start match')} title="Stop/Play">â¯</button>
      <button className={"btn icon like"+(liked?" active":"")} onClick={toggleLike} title="Like">â¤</button>
            <button className="btn icon" onClick={()=>alert('Reported. Thank you.')} title="Report">ğŸš©</button>
          </div>
          <button className="btn big right" onClick={doNext}>Next âŸ©</button>
        </div>

        {/* Ø³ÙƒØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */}
        <div className="messages-rail" aria-live="polite">
          <div className="rail-inner">
            {messages.filter(m=>!!m.text && m.text.trim().length>0).map(m=>(
              <div key={m.id} className={"bubble "+m.kind} title={new Date(m.ts).toLocaleTimeString()}>
                {m.text}
              </div>
            ))}
          </div>
        </div>
      </section>

      {/* Ù†Ø§ÙØ°Ø© ØªØ±Ù‚ÙŠØ© VIP */}
      <UpsellModal open={showUpgrade || showVipFromToolbar} onClose={()=>{ setShowUpgrade(false); setShowVipFromToolbar(false); }} />

      <style jsx>{`
        :global(html,body){ background:#0b0b0b; }
        .root{ height:100svh; display:flex; flex-direction:column; color:#fff; background:#0b0b0b; -webkit-tap-highlight-color:transparent; }
        .section{ position:relative; width:100%; overflow:hidden; background:#000; }
        .section-top{ height:65svh; min-height:65svh; }
        .section-bottom{ flex:1; min-height:35svh; }
        .video{ width:100%; height:100%; object-fit:cover; background:#111; }
        .video.local{ transform:scaleX(-1); }
        .video.local.beauty{ filter:saturate(1.05) contrast(1.05) brightness(1.02) blur(.3px); }
        .overlay{ position:absolute; z-index:2; pointer-events:none; }
        .gradient-top{ inset:0 0 auto 0; height:40%; background:linear-gradient(to bottom, rgba(0,0,0,.55), rgba(0,0,0,0)); }
        .peer-meta-bottom-left{ left:12px; bottom:12px; background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.15); border-radius:10px; padding:6px 10px; display:inline-flex; gap:8px; pointer-events:auto; backdrop-filter:blur(6px); }
        .gender{ font-size:16px; font-weight:700; }
        .place{ font-size:13px; opacity:.95; }
        .top-right-controls{ top:10px; right:10px; display:flex; gap:8px; pointer-events:auto; }
        .chip{ pointer-events:auto; display:inline-flex; align-items:center; gap:8px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.2); border-radius:999px; padding:6px 10px; font-size:12px; color:#fff; }
        .menu{ position:relative; }
        .popover{ position:absolute; top:36px; right:0; background:#0f0f0f; border:1px solid rgba(255,255,255,.18); border-radius:10px; padding:8px; min-width:180px; z-index:5; }
        .pop-wide{ width:min(92vw, 520px); }
        .pop-item{ display:block; width:100%; text-align:left; color:#fff; background:transparent; border:1px solid rgba(255,255,255,.12); border-radius:8px; padding:8px 10px; margin-bottom:6px; }
        .vip-lock{ margin-left:8px; color:#FFD700; font-weight:700; }
        .pop-actions{ display:flex; gap:8px; margin-bottom:8px; }
        .grid{ display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:6px; max-height:38vh; overflow:auto; }
        .country{ display:flex; align-items:center; gap:8px; padding:8px; border:1px solid rgba(255,255,255,.12); border-radius:8px; background:rgba(255,255,255,.05); }
        .country.active{ outline:2px solid #FFD700; }
        .flag{ width:20px; display:inline-block; }
        .name{ font-size:13px; }
        .vip-hint{ margin-top:8px; font-size:12px; opacity:.85; }
        .self-top-right{ top:12px; right:12px; display:flex; align-items:center; gap:8px; pointer-events:auto; }
        .vip-chip{ display:inline-flex; align-items:center; justify-content:center; padding:2px 6px; border-radius:6px; background:rgba(255,215,0,.15); color:#FFD700; font-weight:700; font-size:12px; border:1px solid rgba(255,215,0,.4); }
        .message-input{ position:absolute; left:12px; right:12px; bottom:calc(64px + env(safe-area-inset-bottom,0)); display:flex; gap:8px; background:rgba(20,20,20,.85); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:8px 10px; z-index:3; pointer-events:auto; backdrop-filter:blur(6px); }
        .message-input input{ flex:1; outline:none; background:transparent; border:none; color:#fff; font-size:14px; }
        .message-input .emoji, .message-input .send{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.2); border-radius:10px; padding:6px 10px; color:#fff; }
        .emoji-panel{ position:absolute; left:12px; right:12px; bottom:calc(64px + env(safe-area-inset-bottom,0) + 54px); background:rgba(15,15,15,.95); border:1px solid rgba(255,255,255,.15); border-radius:12px; padding:8px; display:grid; grid-template-columns:repeat(10,1fr); gap:6px; z-index:4; max-height:40vh; overflow:auto; }
        .emoji-panel button{ background:transparent; border:1px solid rgba(255,255,255,.12); border-radius:8px; padding:6px 0; font-size:18px; }
        .toolbar{ position:absolute; left:0; right:0; bottom:env(safe-area-inset-bottom,0); height:64px; display:grid; grid-template-columns:1fr auto 1fr; align-items:center; padding:8px 10px; background:linear-gradient(to top, rgba(0,0,0,.65), rgba(0,0,0,.25)); z-index:2; backdrop-filter:blur(6px); }
        .btn{ pointer-events:auto; color:#fff; }
        .btn.big{ font-weight:800; font-size:16px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.2); border-radius:12px; padding:10px 14px; }
        .btn.big.left{ justify-self:start; } .btn.big.right{ justify-self:end; }
        .center-btns{ display:flex; gap:10px; justify-self:center; }
        .btn.icon{ width:42px; height:42px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.2); display:grid; place-items:center; }
        .btn.icon.like{ color:#FF3B30; } .btn.icon.stop{ color:#FF453A; } .btn.icon.active{ outline:2px solid rgba(255,255,255,.35); }
        .messages-rail{ position:absolute; left:12px; top:-20svh; bottom:90px; width:min(80%, 420px); pointer-events:auto; display:flex; align-items:flex-start; }
        .rail-inner{ display:flex; flex-direction:column; gap:6px; overflow-y:auto; padding-right:8px; align-self:flex-end; max-height:calc(65svh + 35svh - 120px); scrollbar-width:thin; }
        .bubble{ max-width:100%; font-size:13px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.08); backdrop-filter:blur(6px); user-select:text; }
        .bubble.incoming{ background:rgba(255,255,255,.12); }
        .bubble.outgoing{ background:rgba(52,199,89,.20); border-color:rgba(52,199,89,.35); }
        @media (min-width:768px){ .section-top{ height:65vh; min-height:65vh } .section-bottom{ min-height:35vh } .messages-rail{ width:min(60%,520px) } .btn.big{ font-size:18px } }
      `}</style>
      <UpsellModal open={showUpsell} onClose={()=>setShowUpsell(false)} />
    </main>
  );
}

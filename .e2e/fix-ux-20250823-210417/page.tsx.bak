"use client";

import React, { useEffect, useMemo, useRef, useState } from "react";
import Toolbar from "@/components/chat/Toolbar";
import LowerRightQuick from "@/components/chat/LowerRightQuick";
import ChatComposer from "@/components/chat/ChatComposer";
import ChatMessages from "@/components/chat/ChatMessages";
import PeerHeader from "@/components/chat/PeerHeader";
import useSocketProbe from "@/hooks/useSocketProbe";

type ChatMsg = { id: string; from: "me" | "peer"; text: string };

export default function ChatPage() {
  // ====== Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„ØªÙŠ Ù†Ù…Ø±Ø±Ù‡Ø§ Ù„Ù„Ù€ PeerHeader ======
  const [countryPref, setCountryPref] = useState<string>("");
  const [genderPref, setGenderPref]   = useState<string>("any"); // any|male|female|couple|lgbt

  // ====== Ø­Ø§Ù„Ø© Ø§Ø´ØªØ±Ø§Ùƒ/VIP ÙˆÙ„Ø§ÙŠÙƒØ§ØªÙŠ (Ù„Ø£Ø³ÙÙ„ ÙŠÙ…ÙŠÙ†) ======
  const [isVip, setIsVip] = useState<boolean>(false);
  const [likesCount, setLikesCount] = useState<number>(0);

  // ====== (Ø§Ù„Ù…Ù‡Ù…) Ù„Ø§ÙŠÙƒ Ù„Ù„Ù€ peer ÙŠÙØ³ØªØ¹Ù…Ù„Ù‡ Toolbar ======
  const [peerLiked, setPeerLiked] = useState<boolean>(false);
  const handleToggleLike = () => setPeerLiked(v => !v);

  // ====== ÙƒØ§Ù…/Ù…Ø§ÙŠÙƒ/Ø¬Ù…Ø§Ù„ ======
  const [micOn, setMicOn] = useState(true);
  const [camOn, setCamOn] = useState(true);
  const [beautyOn, setBeautyOn] = useState(false);
  const handleToggleMic = () => setMicOn(v => !v);
  const handleToggleCam = () => setCamOn(v => !v);
  const handleSwitchCam = () => {/* Ù„Ø§Ø­Ù‚Ù‹Ø§: Ø¹ÙƒØ³ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */};
  const handleBeauty    = () => setBeautyOn(v => !v);

  // ====== Ø±Ø³Ø§Ø¦Ù„ ======
  const [messages, setMessages] = useState<ChatMsg[]>([
    { id: "m1", from: "peer", text: "ğŸ‘‹ Hi there" },
  ]);
  const handleSend = (t: string) => {
    if (!t.trim()) return;
    setMessages((m) => [...m, { id: crypto.randomUUID(), from: "me", text: t }]);
  };

  // ====== Ø­ÙØ¸/Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ø¨Ø³Ù‘Ø· Ù„Ù„Ù€ localStorage ======
  useEffect(() => {
    try {
      const c0 = localStorage.getItem("countryPref");
      const g0 = localStorage.getItem("genderPref");
      const vip0 = localStorage.getItem("isVip");
      const myLikes0 = localStorage.getItem("likesCount");
      const peerLiked0 = localStorage.getItem("peerLiked");
      if (c0) setCountryPref(c0);
      if (g0) setGenderPref(g0);
      if (vip0) setIsVip(vip0 === "1" || vip0 === "true");
      if (myLikes0) setLikesCount(parseInt(myLikes0, 10) || 0);
      if (peerLiked0) setPeerLiked(peerLiked0 === "1" || peerLiked0 === "true");
    } catch {}
  }, []);
  useEffect(() => {
    try {
      localStorage.setItem("countryPref", countryPref || "");
      localStorage.setItem("genderPref", genderPref || "any");
      localStorage.setItem("isVip", isVip ? "1" : "0");
      localStorage.setItem("likesCount", String(likesCount || 0));
      localStorage.setItem("peerLiked", peerLiked ? "1" : "0");
    } catch {}
  }, [countryPref, genderPref, isVip, likesCount, peerLiked]);

  // ====== Ø³ÙˆÙƒØª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ======
  useSocketProbe(); // Ù„Ù† ÙŠØªØµÙ„ Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† NEXT_PUBLIC_SOCKET_URL Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§

  // ====== Ø±ÙŠÙ†Ø¯Ø±: Ø´Ø¨ÙƒØ© 4 ØµÙÙˆÙ (Ø£Ø¹Ù„Ù‰ Ù†Ø¸ÙŠØ±ØŒ Ù…Ø³Ø§Ø­Ø©ØŒ Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§ØªØŒ Ø§Ù„Ù…Ø¤Ù„Ù) ======
  return (
    <main
      className="min-h-[100dvh] w-screen overflow-hidden text-white bg-gradient-to-b from-slate-900 via-slate-900 to-black"
      style={{ touchAction: "pan-x" }}
    >
      <div className="grid grid-rows-[auto,1fr,auto,auto] h-[100dvh]">

        {/* Row 1: ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„Ù†Ø¸ÙŠØ± (Ø£Ø¹Ù„Ù‰ 50%) */}
        <div className="relative">
          <PeerHeader
            className=""
            info={{
              name: "Guest",
              likes: 123,
              country: "",
              city: "",
              gender: genderPref,
              isVip: true,
            }}
            filters={{ countryPref, genderPref }}
            onFiltersChange={(f: {countryPref: string; genderPref: string}) => {
              setCountryPref(f.countryPref);
              setGenderPref(f.genderPref);
            }}
          />
        </div>

        {/* Row 2: Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©/Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£ÙˆØ³Ø· (ÙŠÙØªØ±Ùƒ Ø¨Ø³ÙŠØ·Ù‹Ø§ Ø§Ù„Ø¢Ù†) */}
        <div className="relative">
          {/* Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§: ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù†Ø¸ÙŠØ±/Ø§Ù„Ø® */}
          <ChatMessages items={messages} mode="latest" />
        </div>

        {/* Row 3: Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª (Ø£Ø³ÙÙ„ØŒ Ù…Ø¹ like Ù„Ù„Ù€ peer) */}
        <div className="relative">
          <Toolbar
            onPrev={() => {}}
            onNext={() => {}}
            muted={!micOn}
            camOn={camOn}
            onToggleMic={handleToggleMic}
            onToggleCam={handleToggleCam}
            liked={peerLiked}
            onToggleLike={handleToggleLike}
            onSettings={() => { window.location.href = "/settings"; }}
            onReport={() => { /* TODO: Ù†Ø§ÙØ°Ø© ØªØ¨Ù„ÙŠØº */ }}
          />
        </div>

        {/* Row 4: Ø§Ù„Ù…Ø¤Ù„Ù/Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ø£Ø³ÙÙ„ Ø£Ø³ÙÙ„) */}
        <div className="relative">
          <ChatComposer open={true} onSend={handleSend} />
          {/* Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø© Ø£Ø¹Ù„Ù‰ ÙŠÙ…ÙŠÙ† Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø© */}
          <div className="absolute right-2 top-2">
            <LowerRightQuick
              onSwitchCam={handleSwitchCam}
              onBeauty={handleBeauty}
              beautyOn={beautyOn}
              likesCount={likesCount}
              isVip={isVip}
            />
          </div>
        </div>
      </div>
    </main>
  );
}
